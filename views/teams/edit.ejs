
<% layout('boilerplate') -%>

<div class="row mt-3">
    <div class="col-lg-12 d-none d-lg-block">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Команды</a></li>
                <li class="breadcrumb-item"><a href="/teams/<%= team.id %>"><%= team.name %></a></li>
                <li class="breadcrumb-item active" aria-current="page">Редактирование команды</li>
            </ol>
        </nav>
    </div>
</div>

<h3>Редактирование команды</h3>

<div class="row">
    <div class="col-lg-6">
        <form action="" id="edit_tournament">
            <div class="errors alert alert-danger hidden"></div>


            <label for="title">Лого</label>
            <div>
                <img class="img-thumbnail" id="image" src="<%=  team.image  %>" alt="">
            </div>

            <div class="form-group">
                <label for="exampleFormControlFile1">Выберите файл</label>
                <input type="file" name="lol" class="form-control-file" id="exampleFormControlFile1">
                <div id="container"></div>
            </div>
            <hr>

            <label for="title">Название команды</label>
            <input type="text" id="title" name="title" class="form-control"
                   value="<%=  team.name  %>">



            <div class="row">
                <div class="col-sm-12">
                    <label for="country" class="mt-3"><%- __("CreateCountry") %></label>
                    <br>
                    <select name="country" class="simple-select2" id="country">
                        <% for (var i in countries) { %>
                        <option value="<%= i %>" <%= (i === team.country) ? "selected" : "" %>><%= countries[i] %></option>
                        <% } %>
                    </select>
                </div>
            </div>


            <div class="form-group mt-3">
                <label for="exampleFormControlTextarea1">Описание</label>
                <textarea class="form-control" id="description" rows="3"><%=  team.description  %></textarea>
            </div>




            <input type="submit" class="btn btn-primary mt-3" value="<%- __("Save") %>">


        </form>
    </div>
</div>


<script src="/js/ju/ju.min.js"></script>
<script src="/js/html5uploader.js"></script>
<script src="/js/ju/datepicker-ru.js"></script>
<link rel="stylesheet" href="/js/ju/ju.min.css">
<link rel="stylesheet" href="/stylesheets/select2.css" />

<link rel="stylesheet" href="/js/select2/dist/select2-bootstrap4.min.css">
<link rel="stylesheet" href="/stylesheets/flags.css">
<script src="/js/select2.js"></script>

<script>
    var team_id = '<%= team.id %>';
</script>


<script>
    $( function() {


        var fileuploader = new Html5Upload({
            input: "#exampleFormControlFile1",
            filenameAttr : "name",
            statusContainer: "#container",
            upload_url : "/teams/upload",
            callbacks: {
                before_send: function(xhr, fd, file){
                    fd.append("team_id", team_id);
                },
                complete: function (response, xhr, responseText) {
                    if (response.status == "ok") {
                        $("#image").attr("src", response.image);
                    } else {
                        alert("Error. Check the file.");
                    }
                    console.log(response);
                }

        }});
        fileuploader.setHandler();




        $("#edit_tournament").on("submit", function () {
            $(".errors").addClass("hidden").empty();

            $.post("/teams/update", {
                team_id : team_id,
                name : $("#title").val(),
                description : $.trim($("#description").val()),
                country : $("#country").val(),
            }).done(function (data) {
                if (data.status != "ok") {
                    $(".errors").removeClass("hidden");
                    for (var obj in data.errors) {
                        $(".errors").append(data.errors[obj].msg);
                    }
                } else {
                    if (data.insertId) {
                        location.href = "/teams/" + data.insertId;
                    }
                }
            }).fail(function (data, jqXHR, textStatus) {
                $(".errors").removeClass("hidden");
                if (data) {
                    for (var obj in data.responseJSON.errors) {
                        $(".errors").append(data.responseJSON.errors[obj].msg + "<br/>");

                    }
                } else {
                    alert("Ошибка сохранения");
                }
            });
            return false;
        });

        $('.simple-select2').select2({
            theme: 'bootstrap4',
            placeholder: "Select an option",
            allowClear: true,
            templateResult: formatCountry,

        });



        function formatCountry (country) {
            if (!country.id) { return country.text; }
            return $country = $(
                '<img src="/img/blank.png" class="flag flag-' + country.id.toLowerCase() + '" alt="" />' +
                ' <span>' + country.text + '</span>'
            );
        };

    } );
</script>


