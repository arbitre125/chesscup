function Html5Upload(a){var b={input:null,post_params:{location:location.href},filenameAttr:null,eventType:"change",upload_url:"response.html",statusContainer:null,cancelAll:"#cancelAll",file_size_limit:1E3,fadeOutTimeout:3E3,callbacks:{fileDialogStart:function(){},before_send:function(a,b,c){},before_upload:function(a,b,c){},progress:function(a,b,c){},success:function(a,b,c){},error:function(a,b,c){},complete:function(a,b,c){},totalComplete:function(){}}};a&&$.extend(!0,b,a);this.elems=$(b.input);
    this.filenameAttr=this.elems.attr("name")||b.input;this.eventType=b.eventType;this.upload_url=b.upload_url;this.fileList=[];this.statusContainer=b.statusContainer;this.userCallbacks=b.callbacks;this.cancelAll=$(b.cancelAll);this.file_size_limit=b.file_size_limit;this.post_params=b.post_params;this.fadeOutTimeout=b.fadeOutTimeout;if(!this.elems||0==this.elems.length)throw Error("input \u043d\u0435 \u0437\u0430\u0434\u0430\u043d \u0438\u043b\u0438 \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d, \u043f\u0440\u043e\u0432\u0435\u0440\u044c\u0442\u0435 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b");
}Html5Upload.prototype.setHandler=function(){var a=this;a.elems.on(a.eventType,function(){a.uploadFile(this.files,arguments)});return $(a.cancelAll).length?($(a.cancelAll).on("click.cancelAll",function(){a.abortAll();return!1}),!0):!1};Html5Upload.prototype.uploadFile=function(a,b){for(var d in a)"object"==typeof a[d]&&(a[d].divEl=new ProgressDiv({container:this.statusContainer,name:a[d].name,fadeOutTimeout:this.fadeOutTimeout}),a[d].divEl.append(),this.fileList.push(a[d]));this.uploadFileOneByOne()};
Html5Upload.prototype.uploadFileOneByOne=function(){this.fileList.length?this.sendFile(this.fileList[0]):this.elems.val("")};Html5Upload.prototype.setProgressBar=function(a,b){var d=this;a.upload.addEventListener("progress",function(e){b.setProgress(e);d.userCallbacks.progress(a,b,e)},!1)};
Html5Upload.prototype.createXHR=function(a){a=new XMLHttpRequest;a.open("POST",this.upload_url,!0);a.setRequestHeader("X-Requested-With","XMLHttpRequest");a.setRequestHeader("Accept","application/json");return this.currentXHR=a};Html5Upload.prototype.checkFileSize=function(a){a.size||console.log("\u041d\u0435 \u043c\u043e\u0433\u0443 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0440\u0430\u0437\u043c\u0435\u0440\u044b \u0444\u0430\u0439\u043b\u0430",a);return a.size/1E6<parseInt(this.file_size_limit)};
Html5Upload.prototype.unshiftFilesArray=function(){this.fileList.length&&this.fileList.shift()};Html5Upload.prototype.abortAll=function(){this.currentXHR&&this.currentXHR.abort();for(var a=0;a<this.fileList.length;a++)"object"==typeof this.fileList[a]&&(this.fileList[a].divEl.setCancel("\u041e\u0442\u043c\u0435\u043d\u0435\u043d\u043e"),this.fileList[a].divEl.hide());this.fileList.length&&(this.fileList=[])};
Html5Upload.prototype.abort=function(a,b,d){b&&b.abort();a.setCancel(d);a.hide();this.unshiftFilesArray();this.uploadFileOneByOne()};Html5Upload.prototype.setPostParams=function(a){for(var b in this.post_params)a.append(b,this.post_params[b])};
Html5Upload.prototype.sendFile=function(a){var b=this,d=a.divEl;if(!this.checkFileSize(a))return this.abort(d,c,"\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u0431\u043e\u043b\u044c\u0448\u043e\u0439 \u0444\u0430\u0439\u043b"),!1;var e=new FormData,c=this.createXHR();this.setProgressBar(c,d);d.progress.find(".progressCancel").on("click",function(){b.abort(d,c,"\u041e\u0442\u043c\u0435\u043d\u0435\u043d\u043e");return!1});e.append(this.filenameAttr,a);this.setPostParams(e);b.userCallbacks.before_send(c,
    e,a);c.send(e);c.onreadystatechange=function(){2==c.readyState&&b.userCallbacks.before_upload(c,e,a);if(4==c.readyState&&200==c.status)try{response="string"==typeof c.responseText?JSON.parse(c.responseText):c.responseText,0==response.status?(b.unshiftFilesArray(),b.uploadFileOneByOne(),d.setError(response,c,c.responseText),d.hide(),b.userCallbacks.error(response,c,c.responseText)):(b.unshiftFilesArray(),b.uploadFileOneByOne(),d.setComplete(response,c,c.responseText),d.hide(),b.userCallbacks.success(response,
        c,c.responseText)),b.userCallbacks.complete(response,c,c.responseText),b.fileList.length||b.userCallbacks.totalComplete()}catch(f){console.log("Can't read response",c.responseText),console.log(f.message)}4==c.readyState&&200!=c.status&&b.userCallbacks.error(c,c.responseText)}};
function ProgressDiv(a){var b={container:null,name:null,fadeOutTimeout:3E3};a&&$.extend(b,a);this.progress=$('<div class="progressWrapper"><div class="progressContainer"><a class="progressCancel" href="#" ></a><div class="progressName">'+b.name+'</div><div class="progressBarStatus">Waiting...</div><div class="progressBarInProgress progress" style="width: 0%;" ></div></div></div>');this.container=$(b.container);this.fadeOutTimeout=b.fadeOutTimeout;if(!b.container||
    0==this.container.length)throw Error("Can't find container");}ProgressDiv.prototype.append=function(){this.container.append(this.progress)};
ProgressDiv.prototype.setProgress=function(a){this.progress.find(".progressBarStatus").html("Uploading...");this.progress.find(".progressContainer").addClass("green");this.progress.find(".progressBarInProgress").css({width:a.loaded/a.total*100+"%"})};
ProgressDiv.prototype.setComplete=function(a){a="undefined"===typeof a.result?"Uploaded":a.result;this.progress.find(".progressBarStatus").html(a);this.progress.find(".progressContainer").removeClass("green").addClass("blue")};
ProgressDiv.prototype.setError=function(a){a="undefined"===typeof a.result?"Error":a.result;this.progress.find(".progressBarStatus").text(a);this.progress.find(".progressContainer").removeClass("green").addClass("red");this.progress.find(".progressBarInProgress").removeClass("progressBarInProgress").addClass("progressBarComplete")};
ProgressDiv.prototype.setCancel=function(a){this.progress.find(".progressBarStatus").text(a);this.progress.find(".progressContainer").removeClass("green").addClass("red");this.progress.find(".progressBarInProgress").removeClass("progressBarInProgress").addClass("progressBarComplete")};
ProgressDiv.prototype.hide=function(){var a=this;this.progress.find(".progressBarInProgress").removeClass("progressBarInProgress").addClass("progressBarComplete");setTimeout(function(){a.progress.fadeOut(300,function(){$(this).remove()})},a.fadeOutTimeout)};
